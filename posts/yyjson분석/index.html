<!doctype html>
<html lang="ko-kr">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>yyjson분석 | 둥충코딩</title>
    <meta name="description" content="" />

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

      
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>

    <style>

      @import url("https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400&display=swap");

      body {
        margin: 0;
        padding: 0;
         
        font:400 16px 'Noto Serif KR', serif;
        line-height: 1.6;
        color: #4a4b4f;
        background-color: #fbfbfb;
      }

      .container {
        max-width: 780px;  
        margin: 0 auto;
        padding: 20px 5px;
      }

      h1 {
        margin: 0 0 40px 0;
        color: #4a4b4f;
      }

      p {
        margin: 0 0 20px 0;
        line-height: 1.7;
      }

      a {
        color: #8f6a60;
        text-decoration: underline;
        text-decoration-thickness: 1px;
        text-underline-offset: 2px;
      }

      a:hover {
        color: #6b5046;
      }

      .section {
        margin-bottom: 40px;
      }

      .works-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #4a4b4f;
      }

      .work-item {
        margin-bottom: 12px;
        line-height: 1.6;
      }

      .work-link {
        display: block;
        text-decoration: none;
        color: #4a4b4f;
      }

      .work-link:hover {
        opacity: 0.8;
      }

      .work-title {
        font-weight: 500;
      }

      .publication {
        color: #8f6a60;
      }

      .year {
        color: #9d9d9d;
      }

      .description {
        color: #9d9d9d;
        font-style: italic;
        margin-top: 4px;
      }

      .contact {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 1px solid #e5e5e5;
      }

      .footer-image {
        margin-top: 30px;
        text-align: left;
      }

      .footer-image img {
        width: 60px;
        height: auto;
        opacity: 0.7;
      }

      @media (max-width: 768px) {
        .container {
          padding: 40px 20px;
        }

        h1 {
          font-size: 22px;
        }

        body {
          font-size: 15px;
        }
      }
      
       
      pre {
        background-color: #f5f5f5;
        padding: 4px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 0px 0;
      }
      
      code {
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 14px;
        line-height: 1.5;
        text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  -moz-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
      }
      
      pre code {
        display: block;
        white-space: pre !important;
        word-wrap: normal !important;
        word-break: normal;
        overflow-x: auto;
      }
      
       
      p code, li code, h1 code, h2 code, h3 code {
        background-color: #f5f5f5;
        padding: 3px 5px;
        border-radius: 3px;
        font-size: 0.9em;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

       
      .post-content mjx-container[display="true"] {
        display: block;
        text-align: center;
        margin: 1em 0;
        overflow-x: auto !important;
        overflow-y: visible !important;
        max-width: 100% !important;
        width: 100% !important;
        box-sizing: border-box;
        padding-top: 1em;
        padding-bottom: 1em;
        min-height: unset;
      }
       
      .post-content mjx-container[display="true"] mjx-math {
        min-width: 0 !important;
        max-width: 100% !important;
        overflow-x: auto !important;
        overflow-y: visible !important;
        white-space: pre;
        box-sizing: border-box;
        min-height: unset;
      }
       
      .post-content {
        overflow-x: auto;
        overflow-y: visible;
      }
      
       
      .post-content img {
        display: block;
        margin-left: auto;
        margin-right: auto;
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
      }
      
       
      .post-content img + em {
        display: block;
        text-align: center;
        font-size: 0.9em;
        color: #777;
        margin-top: -1em;
        margin-bottom: 1.5em;
      }

        .toc {
    border: thin solid ;
    padding: 1rem;
  }

    </style>

    <style>
 
.chatlog {
  font-family: 'Inter', 'Roboto', 'Noto Sans KR', sans-serif;
  font-size: 0.98rem;
  line-height: 1.75;
  color: #333;
  border: 1px solid ;
  border-radius: 10px;
  max-width: 580px;
  margin: 0 auto;
        padding: 20px 20px;
}

 
.chatlog table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.5rem 0;
  font-size: 0.95rem;
}

.chatlog th,
.chatlog td {
  border: 1px solid #ddd;
  padding: 0.75rem;
  text-align: left;
}

.chatlog thead {
  background-color: #f0f0f5;
  font-weight: 600;
}

.chatlog tbody tr:nth-child(even) {
  background-color: #fafafa;
}

 
.chatlog pre {
  background-color: #f5f5f7;
  padding: 4px;
  overflow-x: auto;
  border-radius: 6px;
  font-size: 0.92rem;
  line-height: 1.6;
  margin: 4px;
}

.chatlog code {
  font-family: 'Courier New', monospace;
  color: #2c3e50;
}

 
.chatlog p code {
  background-color: #eef1f5;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-size: 0.95em;
}
.user-bubble {
  background-color: #cdcdcd;
  border-radius: 16px 16px 0 16px;  
  padding: 0.8em 1.2em;
  margin: 0.5em 0 0.5em auto;  
  max-width: 80%;
  display: inline-block;
  position: relative;
}

.user-bubble::before {
  content: "";
  position: absolute;
  left: -10px;
  top: 10px;
  border: 6px solid transparent;
  border-right-color: #cdcdcd;
}

.gpt-line {
  margin: 0.5em 0;
}

.code-block-wrapper {
  margin: 1em 0;
}

.code-title {
  background: #f0f0f0;
  color: #555;
  font-size: 0.8rem;
  font-weight: bold;
  font-family: monospace;
  text-transform: uppercase;    
  padding: 4px 8px;
  border: 1px solid #ddd;
  border-bottom: none;
  border-top-left-radius: 6px;
  border-top-right-radius: 6px;

  min-height: 1.5em;
}

.highlight_wrap {
  border: 1px solid #ddd;
  border-radius: 0 0 6px 6px;
  background: #fff;
}

.highlight {
  margin: 0;           
  padding: 4px 8px;    
}
    </style>
  </head>
  <body>
    <div class="container">
      
<style>
  .post-container {
    max-width: 780px;  
    margin: 0 auto;
    padding: 0 5px;
  }
  
  .post-header {
    margin-bottom: 40px;
  }
  
  .post-title {
    margin-bottom: 10px;
    color: #4a4b4f;
  }
  
  .post-date {
    color: #9d9d9d;
    font-style: italic;
    margin-bottom: 20px;
  }
  
  .post-description {
    font-style: italic;
    color: #666;
    margin-bottom: 30px;
    font-size: 17px;
  }
  
  .post-content {
    line-height: 1.8;
  }
  
  .post-content h2 {
    margin: 30px 0 20px 0;
    color: #4a4b4f;
  }
  
  .post-content p {
    margin-bottom: 20px;
  }
  
  .post-content img {
    display: block;
    width: 80%;
    max-width: 80%;
    height: auto;
    margin: 2rem auto;
    border-radius: 4px;
  }
  
   
  .post-content img + em {
    display: block;
    text-align: center;
    font-size: 0.9em;
    color: #777;
    margin-top: -0.5rem;
    margin-bottom: 2rem;
  }
  
  .post-content em {
    color: #666;
  }
  
  .back-link {
    display: inline-block;
    margin-top: 50px;
    margin-bottom: 30px;
    color: #8f6a60;
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
  }
  
  .back-link:hover {
    color: #6b5046;
  }
</style>

<div class="post-container">
  <div class="post-header">
    <a href="/" class="back-link">← Back to home</a>
    <h1 class="post-title">yyjson분석</h1>
    <div class="post-date">May 2, 2021</div>
  </div>
  
    
        <aside  class="toc" >
            <nav id="TableOfContents">
  <ul>
    <li><a href="#단-두개-파일">단 두개 파일</a></li>
    <li><a href="#cpu-최적화">CPU 최적화</a>
      <ul>
        <li><a href="#1-loop-unrolling">1. Loop unrolling</a></li>
        <li><a href="#2-likely-unlikely">2. Likely, Unlikely</a></li>
        <li><a href="#3-asm-volatile">3. Asm volatile</a></li>
      </ul>
    </li>
    <li><a href="#goto-문">Goto 문</a></li>
    <li><a href="#bytes-매치">Bytes 매치</a></li>
    <li><a href="#character-테이블">Character 테이블</a></li>
  </ul>
</nav>
        </aside>
    

  <div class="post-content">
    <h1 id="yyjson-분석">yyjson 분석</h1>
<p><a href="https://github.com/ibireme/yyjson">yyjson</a>은
현존하는 JSON 파서중 가장 빠르다고 알려져 있는 라이브러리이다.
이 소스코드를 살펴보면서 유용한 것들과 공부할 만한 것 들을 메모한다.</p>
<h2 id="단-두개-파일">단 두개 파일</h2>
<p>yyjson.c , yyjson.h 단 두개 파일만 제공하여
각 프로젝트에 쉽게 빌드할 수 있도록 하였다.</p>
<h2 id="cpu-최적화">CPU 최적화</h2>
<p>json 과 같은 텍스트 분석이 필요로 하는 것은
많은 선후 상태 의존성을 필요로 한다. 따라서 병렬로 수행하기 힘들며
수많은 분기가 존재하여 머신의 성능을 이끌어내기 어려운
분야 중 하나. 따라서 yyjson이 어떤 최적화들을 하였는지
유용한 트릭들을 확인하도록 한다.</p>
<h3 id="1-loop-unrolling">1. Loop unrolling</h3>
<p>루프로 줄여쓸수 있는 코드를 오히려 늘여씀으로서
반복을 판단하는 조건판단의 수를 줄이는 기법
<a href="https://en.wikipedia.org/wiki/Duff%27s_device">Duff&rsquo;s Device</a>
로 알려져 있는 기법이다.
yyjson에서는 이를 repeat 매크로로 풀어낸다.</p>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#57606a">/* Macros used for loop unrolling and other purpose. */</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat2(x)  { x x }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat3(x)  { x x x }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat4(x)  { x x x x }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat8(x)  { x x x x x x x x }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat16(x) { x x x x x x x x x x x x x x x x }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat4_incr(x)  { x(0) x(1) x(2) x(3) }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat8_incr(x)  { x(0) x(1) x(2) x(3) x(4) x(5) x(6) x(7) }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat16_incr(x) { x(0) x(1) x(2) x(3) x(4) x(5) x(6) x(7) \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">                           x(8) x(9) x(10) x(11) x(12) x(13) x(14) x(15) }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define repeat_in_1_18(x) { x(1) x(2) x(3) x(4) x(5) x(6) x(7) \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">                            x(8) x(9) x(10) x(11) x(12) x(13) x(14) x(15) \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">                            x(16) x(17) x(18) }</span></span></span></code></pre></div>
  </div>
</div><p>이는 소스코드에선 하나의 코드를 쓰지만 repeat 매크로를 사용하여
자동으로 반복되도록 확장하는 일종의 snippets 이다.</p>
<h3 id="2-likely-unlikely">2. Likely, Unlikely</h3>
<p>likely, unlikely 매크로는 리눅스 커널 소스코드에서 사용했다고 알려져있는데
이는 Branch 가 발생되는 부분에서 힌트를 주는 것이다.
true 가 많이 발생할 경우는 likely , false가 많이 발생할 경우는
unlikely 등으로 사용한다.</p>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#57606a">/* likely */</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#ifndef yyjson_likely
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#   if yyjson_has_builtin(__builtin_expect) || YYJSON_GCC_VER &gt;= 4
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#       define yyjson_likely(expr) __builtin_expect(!!(expr), 1)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#   else
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#       define yyjson_likely(expr) (expr)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#   endif
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/* unlikely */</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#ifndef yyjson_unlikely
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#   if yyjson_has_builtin(__builtin_expect) || YYJSON_GCC_VER &gt;= 4
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#       define yyjson_unlikely(expr) __builtin_expect(!!(expr), 0)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#   else
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#       define yyjson_unlikely(expr) (expr)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#   endif
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#endif</span></span></span></code></pre></div>
  </div>
</div><p>사실 위 매크로중 중요한 것은 <code>__builtin_expect(!!(expr), 0)</code> 이것이다.
1이면 likely , 0이면 unlikely이다. 이를 지원하는 컴파일러에 여부에 따라
위처럼 묶어준뒤 .c 파일에서</p>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#57606a">/* Macros used to provide branch prediction information for compiler. */</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#undef  likely
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#define likely(x)       yyjson_likely(x)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#undef  unlikely
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#define unlikely(x)     yyjson_unlikely(x)</span></span></span></code></pre></div>
  </div>
</div><p>이렇게 축약하여 사용한다. 지원하지 않는 컴파일러라면 성능이 급격히 떨어지게 되므로
될 수 있는 한 해당 기능을 지원하는 컴파일러를 쓰는 것이 좋다. 위 코드처럼
GCC 4 버젼이상, 그리고 개인적으로 검색해본 결과
<a href="https://llvm.org/docs/BranchWeightMetadata.html">LLVM도 지원</a>
한다.</p>
<p>위 두 매크로를 정의한 뒤에 어휘분석에서 발생하는 모든 if문에서
likely , unlikely를 적당히 버무려 사용하면 된다.</p>
<h3 id="3-asm-volatile">3. Asm volatile</h3>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">skip_ascii_end</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">/*
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     GCC may store src[i] in a register at each line of expr_jump(i) above.
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     These instructions are useless and will degrade performance.
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     This inline asm is a hint for gcc: &#34;the memory has been modified,
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     do not cache it&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#if YYJSON_IS_REAL_GCC
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">__asm</span> <span style="color:#cf222e">volatile</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">:</span><span style="color:#0a3069">&#34;=m&#34;</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>src<span style="color:#1f2328">)</span><span style="color:#0550ae">::</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">likely</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>src <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39;&#34;&#39;</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        val<span style="color:#0550ae">-&gt;</span>tag <span style="color:#0550ae">=</span> <span style="color:#1f2328">((</span>u64<span style="color:#1f2328">)(</span>src <span style="color:#0550ae">-</span> cur<span style="color:#1f2328">)</span> <span style="color:#0550ae">&lt;&lt;</span> YYJSON_TAG_BIT<span style="color:#1f2328">)</span> <span style="color:#0550ae">|</span> YYJSON_TYPE_STR<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>        val<span style="color:#0550ae">-&gt;</span>uni<span style="color:#1f2328">.</span>str <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">const</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>cur<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">*</span>src <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;\0&#39;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">*</span>end <span style="color:#0550ae">=</span> src <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">true</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span></span></span></code></pre></div>
  </div>
</div><p>매우 난해한 코드이다. 인라인 어셈블리로 주석을 잘 읽어보자.</p>
<h2 id="goto-문">Goto 문</h2>
<p>lexer를 제작할때는 상태머신(FSM)을 작성해서 구현하는 경우가 많은데
이때 goto를 사용할 수 있다.
일반적인 goto 문은 로직을 어지럽게 하며 최적화하기도 힘들지만
이런 상태머신을 구현할 때는 오히려 좋은 케이스라고 할 수 있다.</p>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>static_inline <span style="color:#cf222e">bool</span> <span style="color:#6639ba">read_string</span><span style="color:#1f2328">(</span>u8 <span style="color:#0550ae">*</span>cur<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                               u8 <span style="color:#0550ae">**</span>end<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                               yyjson_val <span style="color:#0550ae">*</span>val<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#cf222e">const</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">**</span>msg<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ... 수많은 코드 ...
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">skip_ascii</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">/* Most strings have no escaped characters, so we can jump them quickly. */</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">skip_ascii_begin</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">/*
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     We want to make loop unrolling, as shown in the following code. Some
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     compiler may not generate instructions as expected, so we rewrite it with
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     explicit goto statements. We hope the compiler can generate instructions
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     like this: https://godbolt.org/z/8vjsYq
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">         while (true) repeat16({
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">            if (likely(!(char_is_ascii_stop(*src)))) src++;
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">            else break;
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">         });
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define expr_jump(i) \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">    if (likely(!char_is_ascii_stop(src[i]))) {} \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">    else goto skip_ascii_stop##i;
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define expr_stop(i) \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">    skip_ascii_stop##i: \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">    src += i; \
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">    goto skip_ascii_end;
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">repeat16_incr</span><span style="color:#1f2328">(</span>expr_jump<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    src <span style="color:#0550ae">+=</span> <span style="color:#0550ae">16</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">goto</span> skip_ascii_begin<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">repeat16_incr</span><span style="color:#1f2328">(</span>expr_stop<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#57606a">#undef expr_jump
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#undef expr_stop
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">skip_ascii_end</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ... 수많은 코드 ...
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  </div>
</div><p><code>skip_ascii</code>, <code>skip_ascii_begin</code>, <code>skip_ascii_end</code>
등을 라벨을 사용하여 goto문으로 상태이동을 표현하였다.</p>
<p>이때 재밌는 점은 위에서 설명한 loop unrolling, likely 매크로
등이 쓰인다는 점이다. loop Unrolling 매크로가 풀릴때 코드는 대략
아래 모양으로 만들어진다.</p>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">skip_ascii_begin</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// repeat16_incr(expr_jump); // 이게 풀리면
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">likely</span><span style="color:#1f2328">(</span><span style="color:#0550ae">!</span><span style="color:#6639ba">char_is_ascii_stop</span><span style="color:#1f2328">(</span>src<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">])))</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span> <span style="color:#cf222e">goto</span> skip_ascii_stop0<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">likely</span><span style="color:#1f2328">(</span><span style="color:#0550ae">!</span><span style="color:#6639ba">char_is_ascii_stop</span><span style="color:#1f2328">(</span>src<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">])))</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span> <span style="color:#cf222e">goto</span> skip_ascii_stop1<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">likely</span><span style="color:#1f2328">(</span><span style="color:#0550ae">!</span><span style="color:#6639ba">char_is_ascii_stop</span><span style="color:#1f2328">(</span>src<span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">])))</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span> <span style="color:#cf222e">goto</span> skip_ascii_stop2<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">likely</span><span style="color:#1f2328">(</span><span style="color:#0550ae">!</span><span style="color:#6639ba">char_is_ascii_stop</span><span style="color:#1f2328">(</span>src<span style="color:#1f2328">[</span><span style="color:#0550ae">3</span><span style="color:#1f2328">])))</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span> <span style="color:#cf222e">goto</span> skip_ascii_stop3<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">....</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">likely</span><span style="color:#1f2328">(</span><span style="color:#0550ae">!</span><span style="color:#6639ba">char_is_ascii_stop</span><span style="color:#1f2328">(</span>src<span style="color:#1f2328">[</span><span style="color:#0550ae">15</span><span style="color:#1f2328">])))</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span> <span style="color:#cf222e">goto</span> skip_ascii_stop15<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>src <span style="color:#0550ae">+=</span> <span style="color:#0550ae">16</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">goto</span> skip_ascii_begin<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">skip_ascii_stop0</span><span style="color:#1f2328">:</span> 
</span></span><span style="display:flex;"><span>src <span style="color:#0550ae">+=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> 
</span></span><span style="display:flex;"><span><span style="color:#cf222e">goto</span> skip_ascii_end<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">skip_ascii_stop1</span><span style="color:#1f2328">:</span> 
</span></span><span style="display:flex;"><span>src <span style="color:#0550ae">+=</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">;</span> 
</span></span><span style="display:flex;"><span><span style="color:#cf222e">goto</span> skip_ascii_end<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ... 수많은 코드 ...
</span></span></span></code></pre></div>
  </div>
</div><p>무려 if문이 16번이나 연속 되므로 분기가 많아 느릴것 같아보이지만
if문 안에는 전부 likely매크로가 달려 있어 CPU에 true 힌트를 준다.
즉 힌트를 받은대로 전부 true로 예측하며 빠르게 진행된다.</p>
<h2 id="bytes-매치">Bytes 매치</h2>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#57606a">/** 16/32/64-bit vector union, used for unaligned memory access on modern CPU */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">typedef</span> <span style="color:#cf222e">union</span> v16_uni <span style="color:#1f2328">{</span> v16 v<span style="color:#1f2328">;</span> u16 u<span style="color:#1f2328">;</span> <span style="color:#1f2328">}</span> v16_uni<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">typedef</span> <span style="color:#cf222e">union</span> v32_uni <span style="color:#1f2328">{</span> v32 v<span style="color:#1f2328">;</span> u32 u<span style="color:#1f2328">;</span> <span style="color:#1f2328">}</span> v32_uni<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">typedef</span> <span style="color:#cf222e">union</span> v64_uni <span style="color:#1f2328">{</span> v64 v<span style="color:#1f2328">;</span> u64 u<span style="color:#1f2328">;</span> <span style="color:#1f2328">}</span> v64_uni<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>static_inline <span style="color:#cf222e">bool</span> <span style="color:#6639ba">byte_match_4</span><span style="color:#1f2328">(</span><span style="color:#cf222e">void</span> <span style="color:#0550ae">*</span>buf<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span>pat<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    v32_uni u1<span style="color:#1f2328">,</span> u2<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    u1<span style="color:#1f2328">.</span>v <span style="color:#0550ae">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">(</span>v32 <span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>pat<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    u2<span style="color:#1f2328">.</span>v <span style="color:#0550ae">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">(</span>v32 <span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>buf<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> u1<span style="color:#1f2328">.</span>u <span style="color:#0550ae">==</span> u2<span style="color:#1f2328">.</span>u<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  </div>
</div><p>json 에서  &rsquo;true&rsquo;, &rsquo;null&rsquo; 등의 토큰은 사실 바이트단위로
4번이나 비교할 필요가 없다. 4바이트이므로 그냥 바로 통째로
4바이트 비교를 하면 된다.</p>
<h2 id="character-테이블">Character 테이블</h2>
<p>1바이트문자는 0~255 범위의 값을 가지므로
256개의 테이블을 미리 만들어둔뒤 개별 문자가 지닌 분류 해놓으면
빠르게 개별 char 의 범위를 조건문에서 체크할 필요없이
바로 비교 가능하다.</p>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#1f2328">(</span> <span style="color:#0a3069">&#39;{&#39;</span> <span style="color:#0550ae">==</span> ch <span style="color:#0550ae">||</span> <span style="color:#0a3069">&#39;[&#39;</span> <span style="color:#0550ae">==</span> ch <span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// char type Container
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">switch</span><span style="color:#1f2328">(</span>ch<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">case</span> <span style="color:#0a3069">&#39;\n&#39;</span><span style="color:#0550ae">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">case</span> <span style="color:#0a3069">&#39;\r&#39;</span><span style="color:#0550ae">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">case</span> <span style="color:#0a3069">&#39;\0&#39;</span><span style="color:#0550ae">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">// char type line END
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>		<span style="color:#cf222e">break</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  </div>
</div><p>위 소스는 분기 및 비교가 많다.</p>
<div class="code-block-wrapper">
  <div class="code-title">C</div>
  <div class="highlight_wrap">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#57606a">/** Whitespace character: &#39; &#39;, &#39;\\t&#39;, &#39;\\n&#39;, &#39;\\r&#39;. */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type CHAR_TYPE_SPACE      <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Number character: &#39;-&#39;, [0-9]. */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type CHAR_TYPE_NUMBER     <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** JSON Escaped character: &#39;&#34;&#39;, &#39;\&#39;, [0x00-0x1F]. */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type CHAR_TYPE_ESC_ASCII  <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Non-ASCII character: [0x80-0xFF]. */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type CHAR_TYPE_NON_ASCII  <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">3</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** JSON container character: &#39;{&#39;, &#39;[&#39;. */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type CHAR_TYPE_CONTAINER  <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">4</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Comment character: &#39;/&#39;. */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type CHAR_TYPE_COMMENT    <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Line end character &#39;\\n&#39;, &#39;\\r&#39;, &#39;\0&#39;. */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type CHAR_TYPE_LINE_END   <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">6</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Character type table (generate with misc/make_tables.c) */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">const</span> char_type char_table<span style="color:#1f2328">[</span><span style="color:#0550ae">256</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">0x44</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x05</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x45</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x45</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0x04</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//...
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">//... 256 개의 사전 정의된 types
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Match a character with specified type. */</span>
</span></span><span style="display:flex;"><span>static_inline <span style="color:#cf222e">bool</span> <span style="color:#6639ba">char_is_type</span><span style="color:#1f2328">(</span>u8 c<span style="color:#1f2328">,</span> char_type type<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">(</span>char_table<span style="color:#1f2328">[</span>c<span style="color:#1f2328">]</span> <span style="color:#0550ae">&amp;</span> type<span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Match a whitespace: &#39; &#39;, &#39;\\t&#39;, &#39;\\n&#39;, &#39;\\r&#39;. */</span>
</span></span><span style="display:flex;"><span>static_inline <span style="color:#cf222e">bool</span> <span style="color:#6639ba">char_is_space</span><span style="color:#1f2328">(</span>u8 c<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#6639ba">char_is_type</span><span style="color:#1f2328">(</span>c<span style="color:#1f2328">,</span> CHAR_TYPE_SPACE<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/** Match a whitespace or comment: &#39; &#39;, &#39;\\t&#39;, &#39;\\n&#39;, &#39;\\r&#39;, &#39;/&#39;. */</span>
</span></span><span style="display:flex;"><span>static_inline <span style="color:#cf222e">bool</span> <span style="color:#6639ba">char_is_space_or_comment</span><span style="color:#1f2328">(</span>u8 c<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#6639ba">char_is_type</span><span style="color:#1f2328">(</span>c<span style="color:#1f2328">,</span> CHAR_TYPE_SPACE <span style="color:#0550ae">|</span> CHAR_TYPE_COMMENT<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  </div>
</div><p>위 코드처럼 사전정의된 테이블을 가지고 문자의 종류 판단을 하게 된다.
비트Mask를 활용한 것도 유용하다.</p>

  </div>
  
  <a href="/" class="back-link">← Back to home</a>
</div>

    </div>
    
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  </body>
</html>
